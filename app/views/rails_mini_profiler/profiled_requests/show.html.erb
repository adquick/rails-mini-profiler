<section class="request-details">
  <h1> <%= @profiled_request.request_path %> </h1>

  <ul class="request-details-data">
    <li class="data-item">
      <small>Method</small>
      <span class="pill request-method request-method-<%= @profiled_request.request_method.downcase %>"><%= @profiled_request.request_method %></span>
    </li>
    <li class="data-item">
      <small>Status</small>
      <span class="pill request-status request-status-<%= @profiled_request.response_status %>"><%= @profiled_request.response_status %></span>
    </li>
    <li class="data-item">
      <small>Response Time</small>
      <span><%= (@profiled_request.duration.to_f / 100) %>ms</span>
    </li>
    <li class="data-item">
      <small>Allocations</small>
      <span><%= @profiled_request.allocations %></span>
    </li>

  </ul>

</section>

<section class="request-details-actions">
  <%= form_with id: 'profiled-request-search-form', url: profiled_requests_url, method: :get do |form| %>
    <%= form.search_field :path, id: 'profiled-request-path-search', placeholder: 'Search Traces...', class: 'profiled-request-path-search' %>
  <% end %>
  <%= link_to(flamegraph_path(@profiled_request.id), title: 'Show Flamegraph', class: 'flamegraph-button') do %>
    <button>Display Flamegraph</button>
  <% end %>
</section>

<section>
  <h2>Traces</h2>
  <% traces = @profiled_request.traces.sort_by(&:start) %>
  <% steps = traces
    .map do |trace|
    OpenStruct.new(
      name: trace.name,
      type: trace.name,
      duration: (trace.duration.to_f / 100),
      percent: (trace.duration.to_f / @profiled_request.duration.to_f * 100).round,
      fromStart: (trace.start - @profiled_request.start).to_f / 100,
      payload: trace.payload,
      backtrace: trace.backtrace,
      fromStartPercent: ((trace.start - @profiled_request.start).to_f /
        (@profiled_request.finish - @profiled_request.start)).to_f * 100
    )
  end
  %>

  <ol class="trace-list">
    <% steps.each do |step| %>
      <%= render "rails_mini_profiler/profiled_requests/shared/step", step: step %>
    <% end %>
  </ol>
</section>
